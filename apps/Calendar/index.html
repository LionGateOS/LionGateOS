<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>LionGateOS Calendar — B34 Event Persistence (localStorage)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root{
  --bg-neutral:
    radial-gradient(1200px 800px at 20% 12%, rgba(120,90,255,0.18), transparent 60%),
    radial-gradient(1000px 720px at 80% 26%, rgba(140,180,255,0.12), transparent 65%),
    linear-gradient(180deg, #04050b, #020309);
  --shell-bg: rgba(255,255,255,0.022);
  --card-bg: rgba(255,255,255,0.030);
  --card-bg-hover: rgba(255,255,255,0.048);
  --border: rgba(255,255,255,0.18);
  --border-hover: rgba(140,180,255,0.55);
  --text: rgba(255,255,255,0.94);
  --muted: rgba(255,255,255,0.60);
  --accent: rgba(140,180,255,0.95);
  --glow: rgba(140,180,255,0.38);
  --radius: 22px;
  --cell-radius: 14px;
}
*{ box-sizing:border-box; }
html,body{ height:100%; margin:0; }
body{
  font-family: system-ui, -apple-system, Segoe UI, sans-serif;
  color: var(--text);
  background: var(--bg-neutral);
  overflow:hidden;
}
#app{
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  padding: 16px;
}
.shell{
  width:min(1120px, 100%);
  height:100%;
  display:flex;
  flex-direction:column;
  background: var(--shell-bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  backdrop-filter: blur(28px) saturate(145%);
  box-shadow: 0 40px 130px rgba(0,0,0,0.62);
}
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding: 14px 18px;
  border-bottom: 1px solid var(--border);
}
.controls button{
  background: rgba(255,255,255,0.045);
  border: 1px solid var(--border);
  color: var(--text);
  border-radius: 999px;
  padding: 6px 12px;
  cursor:pointer;
}
.calendar{
  flex:1;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.weekdays{
  display:grid;
  grid-template-columns: repeat(7, 1fr);
  gap:6px;
}
.weekday{
  text-align:center;
  font-size:12px;
  color:var(--muted);
}
.grid{
  flex:1;
  display:grid;
  grid-template-columns: repeat(7, 1fr);
  grid-template-rows: repeat(6, 1fr);
  gap:6px;
}
.day{
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: var(--cell-radius);
  padding:6px;
  display:flex;
  flex-direction:column;
  gap:4px;
  cursor:pointer;
}
.day:hover{
  background: var(--card-bg-hover);
  border-color: var(--border-hover);
}
.day.outside{ opacity:0.32; cursor:default; }
.day.today{ box-shadow:0 0 0 1px var(--accent) inset; }
.day-number{
  font-weight:700;
  font-size:13px;
}
.event{
  background: rgba(140,180,255,0.22);
  border: 1px solid rgba(140,180,255,0.45);
  border-radius:8px;
  padding:2px 6px;
  font-size:11px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
/* Modal */
.modal-backdrop{
  position:fixed;
  inset:0;
  background: rgba(0,0,0,0.55);
  display:none;
  align-items:center;
  justify-content:center;
}
.modal{
  width:320px;
  background: #0b0e1a;
  border:1px solid var(--border);
  border-radius:16px;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.modal input,
.modal select{
  background:#11152a;
  border:1px solid var(--border);
  color:var(--text);
  padding:8px;
  border-radius:8px;
}
.modal .row{
  display:flex;
  gap:8px;
}
.modal button{
  flex:1;
  background: rgba(140,180,255,0.22);
  border:1px solid rgba(140,180,255,0.45);
  color:var(--text);
  border-radius:8px;
  padding:8px;
  cursor:pointer;
}
.modal button.danger{
  background: rgba(255,120,120,0.22);
  border-color: rgba(255,120,120,0.45);
}
</style>
</head>
<body>
<div id="app">
  <div class="shell">
    <div class="header">
      <h1 id="monthLabel"></h1>
      <div class="controls">
        <button id="prevBtn">◀</button>
        <button id="todayBtn">Today</button>
        <button id="nextBtn">▶</button>
      </div>
    </div>
    <div class="calendar">
      <div class="weekdays">
        <div class="weekday">Sun</div><div class="weekday">Mon</div><div class="weekday">Tue</div>
        <div class="weekday">Wed</div><div class="weekday">Thu</div><div class="weekday">Fri</div>
        <div class="weekday">Sat</div>
      </div>
      <div class="grid" id="calendarGrid"></div>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal">
    <strong id="modalTitle">Add Event</strong>
    <input id="eventTitle" placeholder="Event title"/>
    <select id="eventLabel">
      <option value="">Label (optional)</option>
      <option value="Personal">Personal</option>
      <option value="Work">Work</option>
      <option value="Travel">Travel</option>
      <option value="Reminder">Reminder</option>
    </select>
    <div class="row">
      <button id="saveEvent">Save</button>
      <button id="deleteEvent" class="danger" style="display:none;">Delete</button>
    </div>
  </div>
</div>

<script>
/* ========= Persistence ========= */
const STORAGE_KEY = "lgos.calendar.events";
function loadEvents(){
  try{
    const raw = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    // Backward-compatible: older events may not have "label"
    return Array.isArray(raw) ? raw.map(e => ({
      title: (e && typeof e.title === "string") ? e.title : "",
      date:  (e && typeof e.date  === "string") ? e.date  : "",
      label: (e && typeof e.label === "string") ? e.label : ""
    })).filter(e => e.title && e.date) : [];
  }catch(e){
    return [];
  }
}
function saveEvents(list){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
}

/* ========= State ========= */
let EVENTS = loadEvents();
let selectedDate = null;
let editingIndex = null;

let viewDate = new Date();
const grid = document.getElementById("calendarGrid");
const label = document.getElementById("monthLabel");

function isToday(d){
  const t = new Date();
  return d.getFullYear()===t.getFullYear() &&
         d.getMonth()===t.getMonth() &&
         d.getDate()===t.getDate();
}

function renderCalendar(){
  grid.innerHTML = "";
  const y = viewDate.getFullYear();
  const m = viewDate.getMonth();
  label.textContent = viewDate.toLocaleString(undefined,{month:"long",year:"numeric"});

  const first = new Date(y,m,1).getDay();
  const days = new Date(y,m+1,0).getDate();
  const prev = new Date(y,m,0).getDate();

  for(let i=0;i<42;i++){
    const cell = document.createElement("div");
    cell.className = "day";

    let d, outside=false, offset=0;
    if(i<first){ d = prev-first+i+1; outside=true; offset=-1; }
    else if(i>=first+days){ d=i-(first+days)+1; outside=true; offset=1; }
    else{ d=i-first+1; }

    const cellDate = new Date(y,m+offset,d);
    if(outside) cell.classList.add("outside");
    if(isToday(cellDate)) cell.classList.add("today");

    cell.innerHTML = `<div class="day-number">${d}</div>`;

    if(!outside){
      cell.onclick = () => openModal(cellDate);
      EVENTS.filter(e=>e.date===cellDate.toISOString().slice(0,10))
            .forEach((e,idx)=>{
              const el=document.createElement("div");
              el.className="event";
              el.textContent = (e.label ? `${e.label}: ` : "") + e.title;
              el.onclick = (ev)=>{ ev.stopPropagation(); openModal(cellDate, idx); };
              cell.appendChild(el);
            });
    }
    grid.appendChild(cell);
  }
}

/* ========= Modal ========= */
function openModal(date, idx=null){
  selectedDate = date;
  editingIndex = idx;
  document.getElementById("modalBackdrop").style.display="flex";
  document.getElementById("eventTitle").value = (idx!==null) ? EVENTS[idx].title : "";
  document.getElementById("eventLabel").value = (idx!==null) ? (EVENTS[idx].label || "") : "";
  document.getElementById("modalTitle").textContent = (idx!==null) ? "Edit Event" : "Add Event";
  document.getElementById("deleteEvent").style.display = (idx!==null) ? "block" : "none";
}

document.getElementById("saveEvent").onclick = () => {
  const title = document.getElementById("eventTitle").value.trim();
  const labelVal = (document.getElementById("eventLabel").value || "").trim();
  if(!title || !selectedDate) return;
  const dateStr = selectedDate.toISOString().slice(0,10);
  if(editingIndex!==null){
    EVENTS[editingIndex].title = title;
    EVENTS[editingIndex].label = labelVal;
  }else{
    EVENTS.push({ title, date: dateStr, label: labelVal });
  }
  saveEvents(EVENTS);
  closeModal();
  renderCalendar();
};

document.getElementById("deleteEvent").onclick = () => {
  if(editingIndex!==null){
    EVENTS.splice(editingIndex,1);
    saveEvents(EVENTS);
    closeModal();
    renderCalendar();
  }
};

function closeModal(){
  document.getElementById("modalBackdrop").style.display="none";
  selectedDate=null; editingIndex=null;
}

document.getElementById("modalBackdrop").onclick = (e)=>{
  if(e.target.id==="modalBackdrop") closeModal();
};

/* ========= Nav ========= */
document.getElementById("prevBtn").onclick=()=>{ viewDate.setMonth(viewDate.getMonth()-1); renderCalendar(); };
document.getElementById("nextBtn").onclick=()=>{ viewDate.setMonth(viewDate.getMonth()+1); renderCalendar(); };
document.getElementById("todayBtn").onclick=()=>{ viewDate=new Date(); renderCalendar(); };

renderCalendar();
</script>
</body>
</html>
